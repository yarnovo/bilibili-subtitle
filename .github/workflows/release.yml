name: Build and Release Extension

# è§¦å‘æ¡ä»¶
on:
  # æ¨é€åˆ° master åˆ†æ”¯
  push:
    branches: [ master ]
    tags:
      - 'v*.*.*'  # ç‰ˆæœ¬æ ‡ç­¾ (v1.0.0, v1.2.3, etc.)
  
  # Pull Request åˆ° master åˆ†æ”¯
  pull_request:
    branches: [ master ]
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

# æƒé™è®¾ç½®
permissions:
  contents: write  # åˆ›å»º release éœ€è¦å†™æƒé™

# å®šä¹‰ä½œä¸š
jobs:
  # æ„å»ºä½œä¸š - æ€»æ˜¯è¿è¡Œ
  build:
    name: Build Extension
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [20.x]
    
    steps:
      # æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4
      
      # è®¾ç½® Node.js
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'pnpm'
      
      # å®‰è£… PNPM
      - name: Install PNPM
        uses: pnpm/action-setup@v4
        with:
          version: 9
      
      # å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: pnpm install
      
      # ä»£ç æ£€æŸ¥
      - name: Lint code
        run: pnpm run lint
      
      # æ„å»ºæ‰©å±•
      - name: Build extension
        run: pnpm run build
      
      # éªŒè¯æ„å»ºè¾“å‡º
      - name: Verify build output
        run: |
          if [ ! -f "dist/manifest.json" ]; then
            echo "Build failed: dist/manifest.json not found"
            exit 1
          fi
          if [ ! -d "dist/assets" ]; then
            echo "Build failed: dist/assets directory not found"
            exit 1
          fi
          echo "âœ… Build successful"
      
      # ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: extension-build-${{ github.sha }}
          path: dist/
          retention-days: 30

  # å‘å¸ƒä½œä¸š - ä»…åœ¨ç‰ˆæœ¬æ ‡ç­¾æ—¶è¿è¡Œ
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: build
    # åªæœ‰åœ¨ push äº‹ä»¶ä¸”æ ‡ç­¾åŒ¹é… v*.*.* æ ¼å¼æ—¶æ‰è¿è¡Œ
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    
    steps:
      # æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4
      
      # è®¾ç½® Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'pnpm'
      
      # å®‰è£… PNPM
      - name: Install PNPM
        uses: pnpm/action-setup@v4
        with:
          version: 9
      
      # å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: pnpm install
      
      # ä»£ç æ£€æŸ¥
      - name: Lint code
        run: pnpm run lint
      
      # æ„å»ºæ‰©å±•
      - name: Build extension
        run: pnpm run build
      
      # éªŒè¯ç‰ˆæœ¬æ ‡ç­¾ä¸ package.json åŒ¹é…
      - name: Verify version tag
        id: version
        run: |
          TAG_VERSION=${GITHUB_REF#refs/tags/v}
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          
          echo "Tag version: $TAG_VERSION"
          echo "Package version: $PACKAGE_VERSION"
          
          if [ "$TAG_VERSION" != "$PACKAGE_VERSION" ]; then
            echo "âŒ Version mismatch: tag v$TAG_VERSION != package.json v$PACKAGE_VERSION"
            exit 1
          fi
          
          echo "version=$TAG_VERSION" >> $GITHUB_OUTPUT
          echo "âœ… Version tag matches package.json"
      
      # æ‰“åŒ…æ‰©å±•
      - name: Package extension
        run: |
          cd dist
          zip -r ../bilibili-subtitle-extractor-extension-v${{ steps.version.outputs.version }}.zip .
          cd ..
          
          # éªŒè¯zipæ–‡ä»¶
          if [ ! -f "bilibili-subtitle-extractor-extension-v${{ steps.version.outputs.version }}.zip" ]; then
            echo "âŒ Failed to create zip file"
            exit 1
          fi
          
          echo "âœ… Extension packaged successfully"
      
      # åˆ›å»º GitHub Release
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Extension Release ${{ github.ref_name }}
          body: |
            ## ğŸš€ Bilibiliå­—å¹•æå–æµè§ˆå™¨æ’ä»¶ ${{ github.ref_name }}
            
            ### ğŸ“¦ å®‰è£…æ–¹å¼
            
            #### æ–¹æ³•ä¸€ï¼šç›´æ¥ä¸‹è½½å®‰è£…ï¼ˆæ¨èï¼‰
            1. ä¸‹è½½ä¸‹æ–¹çš„ `bilibili-subtitle-extractor-extension-v${{ steps.version.outputs.version }}.zip` æ–‡ä»¶
            2. è§£å‹åˆ°æœ¬åœ°æ–‡ä»¶å¤¹
            3. æ‰“å¼€Chromeæµè§ˆå™¨ï¼Œè®¿é—® `chrome://extensions/`
            4. å¯ç”¨å³ä¸Šè§’çš„"å¼€å‘è€…æ¨¡å¼"
            5. ç‚¹å‡»"åŠ è½½å·²è§£å‹çš„æ‰©å±•ç¨‹åº"
            6. é€‰æ‹©è§£å‹åçš„æ–‡ä»¶å¤¹
            
            #### æ–¹æ³•äºŒï¼šæœ¬åœ°æ„å»º
            ```bash
            # å…‹éš†é¡¹ç›®
            git clone https://github.com/yarnovo/bilibili-subtitle-extractor-extension.git
            cd bilibili-subtitle-extractor-extension
            
            # å®‰è£…ä¾èµ–å¹¶æ„å»º
            npm install
            npm run build
            
            # åœ¨Chromeä¸­åŠ è½½ dist ç›®å½•
            ```
            
            ### âœ¨ æ–°åŠŸèƒ½
            - ğŸ¯ æ”¯æŒä»ä»»æ„Bilibiliè§†é¢‘æå–å­—å¹•
            - âš¡ ä¼˜åŒ–ä¸MCPæœåŠ¡å™¨çš„WebSocketé€šä¿¡
            - ğŸ”— æ”¯æŒç”Ÿæˆå¸¦æ—¶é—´æˆ³çš„è§†é¢‘è·³è½¬é“¾æ¥
            - ğŸ“Š æ”¹è¿›è¿æ¥çŠ¶æ€ç›‘æ§
            
            ### ğŸ”§ ä½¿ç”¨è¯´æ˜
            1. ç¡®ä¿å·²å¯åŠ¨ [MCPæœåŠ¡å™¨](https://github.com/yarnovo/bilibili-subtitle-extractor-mcp)
            2. è®¿é—®ä»»æ„Bilibiliè§†é¢‘é¡µé¢
            3. æ’ä»¶å°†è‡ªåŠ¨è¿æ¥åˆ°MCPæœåŠ¡å™¨
            4. é€šè¿‡AIåŠ©æ‰‹è°ƒç”¨å­—å¹•æå–åŠŸèƒ½
            
            ### ğŸ”— ç›¸å…³é“¾æ¥
            - ğŸ–¥ï¸ MCPæœåŠ¡å™¨: [GitHub](https://github.com/yarnovo/bilibili-subtitle-extractor-mcp)
            - ğŸ‹ Dockeré•œåƒ: [Docker Hub](https://hub.docker.com/r/yarnovo/bilibili-subtitle-extractor-mcp)
            - ğŸ“– å®Œæ•´æ–‡æ¡£: [README.md](./README.md)
            
            ---
            
            ### ğŸ“‹ ç³»ç»Ÿè¦æ±‚
            - Chrome 88+ æˆ– Edge 88+
            - éœ€è¦é…åˆMCPæœåŠ¡å™¨ä½¿ç”¨
            
            ### ğŸ› é—®é¢˜åé¦ˆ
            å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·åœ¨ [Issues](https://github.com/yarnovo/bilibili-subtitle-extractor-extension/issues) ä¸­åé¦ˆ
          files: |
            bilibili-subtitle-extractor-extension-v${{ steps.version.outputs.version }}.zip
          draft: false
          prerelease: false

  # çŠ¶æ€æ£€æŸ¥ä½œä¸š
  status-check:
    name: Status Check
    runs-on: ubuntu-latest
    needs: [build, release]
    if: always()
    
    steps:
      - name: Check build results
        run: |
          if [ "${{ needs.build.result }}" != "success" ]; then
            echo "âŒ Build failed"
            exit 1
          fi
          echo "âœ… Build successful"
      
      - name: Check release results
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
        run: |
          if [ "${{ needs.release.result }}" != "success" ]; then
            echo "âŒ Release failed"
            exit 1
          fi
          echo "âœ… Extension released successfully" 