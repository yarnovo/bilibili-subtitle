name: Build and Release Extension

# è§¦å‘æ¡ä»¶
on:
  # æ¨é€åˆ° master åˆ†æ”¯
  push:
    branches: [ master ]
    tags:
      - 'v*.*.*'          # æ­£å¼ç‰ˆæœ¬æ ‡ç­¾ (v1.0.0, v1.2.3, etc.)
      - 'v*.*.*-*'        # é¢„å‘å¸ƒç‰ˆæœ¬æ ‡ç­¾ (v1.2.4-alpha.0, v1.0.0-beta.1, etc.)
  
  # Pull Request åˆ° master åˆ†æ”¯
  pull_request:
    branches: [ master ]
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

# æƒé™è®¾ç½®
permissions:
  contents: write  # åˆ›å»º release éœ€è¦å†™æƒé™

# å®šä¹‰ä½œä¸š
jobs:
  # æ„å»ºä½œä¸š - æ€»æ˜¯è¿è¡Œ
  build:
    name: Build Extension
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [20.x]
    
    steps:
      # æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4
      
      # å®‰è£… PNPM
      - name: Install PNPM
        uses: pnpm/action-setup@v4
        with:
          version: 9
      
      # è®¾ç½® Node.js
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'pnpm'
      
      # å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: pnpm install
      
      # ä»£ç æ£€æŸ¥
      - name: Lint code
        run: pnpm run lint
      
      # æ„å»ºæ‰©å±•
      - name: Build extension
        run: pnpm run build
      
      # éªŒè¯æ„å»ºè¾“å‡º
      - name: Verify build output
        run: |
          if [ ! -f "dist/manifest.json" ]; then
            echo "Build failed: dist/manifest.json not found"
            exit 1
          fi
          if [ ! -d "dist/assets" ]; then
            echo "Build failed: dist/assets directory not found"
            exit 1
          fi
          echo "âœ… Build successful"
      
      # ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: extension-build-${{ github.sha }}
          path: dist/
          retention-days: 30

  # å‘å¸ƒä½œä¸š - ä»…åœ¨ç‰ˆæœ¬æ ‡ç­¾æ—¶è¿è¡Œ
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: build
    # åªæœ‰åœ¨ push äº‹ä»¶ä¸”æ ‡ç­¾åŒ¹é… v*.*.* æ ¼å¼æ—¶æ‰è¿è¡Œ
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    
    steps:
      # æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4
      
      # å®‰è£… PNPM
      - name: Install PNPM
        uses: pnpm/action-setup@v4
        with:
          version: 9
      
      # è®¾ç½® Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'pnpm'
      
      # å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: pnpm install
      
      # ä»£ç æ£€æŸ¥
      - name: Lint code
        run: pnpm run lint
      
      # æ„å»ºæ‰©å±•
      - name: Build extension
        run: pnpm run build
      
      # éªŒè¯ç‰ˆæœ¬æ ‡ç­¾ä¸ package.json åŒ¹é…
      - name: Verify version tag
        id: version
        run: |
          TAG_VERSION=${GITHUB_REF#refs/tags/v}
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          
          echo "Tag version: $TAG_VERSION"
          echo "Package version: $PACKAGE_VERSION"
          
          if [ "$TAG_VERSION" != "$PACKAGE_VERSION" ]; then
            echo "âŒ Version mismatch: tag v$TAG_VERSION != package.json v$PACKAGE_VERSION"
            exit 1
          fi
          
          # æ£€æµ‹æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬
          if [[ "$TAG_VERSION" =~ -.*$ ]]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
            echo "ğŸ”„ Detected prerelease version: $TAG_VERSION"
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
            echo "ğŸš€ Detected stable version: $TAG_VERSION"
          fi
          
          echo "version=$TAG_VERSION" >> $GITHUB_OUTPUT
          echo "âœ… Version tag matches package.json"
      
      # æ‰“åŒ…æ‰©å±•
      - name: Package extension
        run: |
          cd dist
          zip -r ../bilibili-subtitle-extractor-extension-v${{ steps.version.outputs.version }}.zip .
          cd ..
          
          # éªŒè¯zipæ–‡ä»¶
          if [ ! -f "bilibili-subtitle-extractor-extension-v${{ steps.version.outputs.version }}.zip" ]; then
            echo "âŒ Failed to create zip file"
            exit 1
          fi
          
          echo "âœ… Extension packaged successfully"
      
      # åˆ›å»º GitHub Release
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ steps.version.outputs.is_prerelease == 'true' && format('Prerelease {0}', github.ref_name) || format('Extension Release {0}', github.ref_name) }}
          body: |
            ## ${{ steps.version.outputs.is_prerelease == 'true' && 'ğŸ”„ Prerelease' || 'ğŸš€ Release' }} ${{ github.ref_name }}
            
            ${{ steps.version.outputs.is_prerelease == 'true' && 'âš ï¸ **è¿™æ˜¯ä¸€ä¸ªé¢„å‘å¸ƒç‰ˆæœ¬ï¼Œå¯èƒ½åŒ…å«æœªå®Œå…¨æµ‹è¯•çš„åŠŸèƒ½ï¼Œå»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è°¨æ…ä½¿ç”¨ã€‚**' || '' }}
            
            ### ğŸ“‹ æ›´æ–°å†…å®¹
            æŸ¥çœ‹æœ¬ç‰ˆæœ¬çš„è¯¦ç»†æ›´æ–°å†…å®¹å’Œä»£ç å˜æ›´ï¼Œè¯·è®¿é—®ï¼š
            **[ğŸ“– æŸ¥çœ‹ ${{ github.ref_name }} ç‰ˆæœ¬æ›´æ–°å†…å®¹](https://github.com/yarnovo/bilibili-subtitle/commits/${{ github.ref_name }})**
            
            ### ğŸ“¦ å®‰è£…æ–¹å¼
            
            #### æ–¹æ³•ä¸€ï¼šç›´æ¥ä¸‹è½½å®‰è£…ï¼ˆæ¨èï¼‰
            1. ä¸‹è½½ä¸‹æ–¹çš„ `bilibili-subtitle-extractor-extension-v${{ steps.version.outputs.version }}.zip` æ–‡ä»¶
            2. è§£å‹åˆ°æœ¬åœ°æ–‡ä»¶å¤¹
            3. æ‰“å¼€Chromeæµè§ˆå™¨ï¼Œè®¿é—® `chrome://extensions/`
            4. å¯ç”¨å³ä¸Šè§’çš„"å¼€å‘è€…æ¨¡å¼"
            5. ç‚¹å‡»"åŠ è½½å·²è§£å‹çš„æ‰©å±•ç¨‹åº"
            6. é€‰æ‹©è§£å‹åçš„æ–‡ä»¶å¤¹
            
            #### æ–¹æ³•äºŒï¼šæœ¬åœ°æ„å»º
            ```bash
            # å…‹éš†é¡¹ç›®
            git clone https://github.com/yarnovo/bilibili-subtitle.git
            cd bilibili-subtitle/bilibili-subtitle
            
            # å®‰è£…ä¾èµ–å¹¶æ„å»º
            pnpm install
            pnpm run build
            
            # åœ¨Chromeä¸­åŠ è½½ dist ç›®å½•
            ```
            
            ### ğŸ”§ ä½¿ç”¨è¯´æ˜
            1. ç¡®ä¿å·²å¯åŠ¨ [MCPæœåŠ¡å™¨](https://github.com/yarnovo/bilibili-subtitle-extractor-mcp)
            2. è®¿é—®ä»»æ„Bilibiliè§†é¢‘é¡µé¢
            3. æ’ä»¶å°†è‡ªåŠ¨è¿æ¥åˆ°MCPæœåŠ¡å™¨
            4. é€šè¿‡AIåŠ©æ‰‹è°ƒç”¨å­—å¹•æå–åŠŸèƒ½
            
            ### ğŸ”— ç›¸å…³é“¾æ¥
            - ğŸ–¥ï¸ MCPæœåŠ¡å™¨: [GitHub](https://github.com/yarnovo/bilibili-subtitle-extractor-mcp)
            - ğŸ‹ Dockeré•œåƒ: [Docker Hub](https://hub.docker.com/r/yarnovo/bilibili-subtitle-extractor-mcp)
            - ğŸ“– å®Œæ•´æ–‡æ¡£: [README.md](https://github.com/yarnovo/bilibili-subtitle/blob/master/bilibili-subtitle/README.md)
            
            ---
            
            ### ğŸ“‹ ç³»ç»Ÿè¦æ±‚
            - Chrome 88+ æˆ– Edge 88+
            - éœ€è¦é…åˆMCPæœåŠ¡å™¨ä½¿ç”¨
            
            ### ğŸ› é—®é¢˜åé¦ˆ
            å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·åœ¨ [Issues](https://github.com/yarnovo/bilibili-subtitle/issues) ä¸­åé¦ˆ
          files: |
            bilibili-subtitle-extractor-extension-v${{ steps.version.outputs.version }}.zip
          draft: false
          prerelease: ${{ steps.version.outputs.is_prerelease == 'true' }}

  # çŠ¶æ€æ£€æŸ¥ä½œä¸š
  status-check:
    name: Status Check
    runs-on: ubuntu-latest
    needs: [build, release]
    if: always()
    
    steps:
      - name: Check build results
        run: |
          if [ "${{ needs.build.result }}" != "success" ]; then
            echo "âŒ Build failed"
            exit 1
          fi
          echo "âœ… Build successful"
      
      - name: Check release results
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
        run: |
          if [ "${{ needs.release.result }}" != "success" ]; then
            echo "âŒ Release failed"
            exit 1
          fi
          echo "âœ… Extension released successfully" 